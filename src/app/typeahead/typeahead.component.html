<form [formGroup]="typeaheadForm">
    <ng-container *ngIf="settings.multiple" >


      <div class="typeahead-input" (click)="onInputFocus($event)">
        <div class="{{optionSelection.selected().length > 0 ? 'has-items': ''}}">
          <app-tag-badge *ngFor="let option of optionSelection.selected()">
            {{ settings.displayFn(option) }}
            <i class="fa fa-times" (click)="toggleSelection(option)" tabindex="0" aria-label="close"></i>
          </app-tag-badge>

          <!--  (focus)="onInputFocus($event)"-->
          <input #input [id]="settings.id" type="text" autocomplete="off" formControlName="typeahead">
          <div class="spinner-border spinner-border-sm" role="status" *ngIf="isLoadingOptions">
            <span class="sr-only">Loading...</span>
          </div>
        </div>
      </div>
      <div class="dropdown" *ngIf="hasFocus">
        <ul class="list-group results" #results>
          <!-- <li *ngIf="hasFocus && !typeaheadControl.value && (filteredOptions | async)?.length === 0" class="list-group-item">
            Type to search
          </li> -->
          <ng-container *ngIf="filteredOptions | async as options">
            <li *ngIf="showAddItem" 
              class="list-group-item add-item" role="option" (mouseenter)="focusedIndex = 0; updateHighlight();" (click)="addNewItem(typeaheadControl.value)" >
              Add {{typeaheadControl.value}}...
            </li>
            <li *ngFor="let option of options; let index = index;" (click)="toggleSelection(option)"  
                class="list-group-item" role="option"
                (mouseenter)="focusedIndex = index + (showAddItem ? 1 : 0); updateHighlight();">
              <ng-container [ngTemplateOutlet]="optionTemplate" [ngTemplateOutletContext]="{ $implicit: option, idx: index }"></ng-container>
            </li>
          </ng-container>
        </ul>
      </div>


  </ng-container>
  <ng-container *ngIf="!settings.multiple">
    <!-- <mat-form-field  style="width:96%;">
      <input type="text" matInput [matAutocomplete]="auto"  [formControl]="typeaheadControl">
        <mat-autocomplete #auto="matAutocomplete">
          <mat-option *ngIf="!typeaheadControl.value" (click)="$event.stopPropagation()" disabled >
            Type to search
          </mat-option>
          <ng-container *ngIf="(filteredOptions | async)?.length > 0; else noResults">
            <mat-option *ngFor="let option of (filteredOptions | async)" [value]="settings.displayFn(option)" (click)="toggleSingle(option)">
              <div style="width:100%">
                <ng-container [ngTemplateOutlet]="optionTemplate" [ngTemplateOutletContext]="{ $implicit: option, idx: index }"></ng-container>
              </div>
            </mat-option>
          </ng-container>
          <mat-option *ngIf="isLoadingOptions" disabled> 
            <mat-spinner diameter="20"></mat-spinner>
          </mat-option>
          <ng-template #noResults>
            <mat-option *ngIf="!isLoadingOptions && typeaheadControl.value && typeaheadControl.value.length > settings.minCharacters && typeaheadControl.dirty" (click)="$event.stopPropagation()" disabled>
              No Results Found
            </mat-option>
          </ng-template>
        </mat-autocomplete>
    </mat-form-field> -->

  </ng-container>
  </form>